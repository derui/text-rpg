# characterについて #
characterとは、あるactorにおける振る舞いを定義したテンプレートを指す。Actorには一切の独自の挙動は存在していない分、それぞれのActorに対する独自の挙動などは、全てこのCharacterに収められている。

characterは単純なテンプレートであり、設定されたActorのデータを利用して、それぞれの振る舞いを行う。そのため、Actor間の何らかの情報のやり取りは、すべてこのCharacterがインターフェースとして行われる。
characterはテンプレートとして、以下の項目を定義する必要がある。

- メッセージハンドラ
- Characterの毎ターン毎に行う行動
- Characterが削除されるかどうかのロジック
- 所有しているActor

このため、Character自体はあるオブジェクトとして定義され、その実装が存在する、ということになる。そのため、Character自体は構造的部分型として扱えるようにobjectとして扱われる。

## メッセージハンドラのシグネチャ ##
メッセージハンドラは、次のような引数と返り値を持つ関数であればなんでもよい。

```
message -> (character, message option)
```

すべてのメッセージには、送信元が必ず指定されている。メッセージハンドラの結果において、messageが返された場合、このメッセージは次のメッセージ処理で利用されることとなる。

ただし、メッセージハンドラを実行するCharacterと、返却値として返されるCharacterは同一のIDを持つものでなければならない。

## Character同士のやりとり ##
character同士のやり取りは、 メッセージと呼ばれる単位を用いて、以下のようなプロセスで行う。これらの処理はモジュール内におけるシンプルな関数として実施される。

1. あるCharacter（Aとする）が、あるCharacter（Bとする）に対してメッセージ a を送る。
2. Bが保有しているイベントハンドラに対してメッセージ a が渡される
3. Bはイベントハンドラにおいて、更新された自分のActor（更新されない場合ももちろんある）と、メッセージを送信してきた相手に対する新しいメッセージを返す。
   − 返信するメッセージがない場合は、この時点でメッセージ自体が終了する。
4. メッセージ送信処理が完了すると、送信元Aと送信先Bにおける、処理後のCharacterが返される。

全てのやりとりは事前に定義されたメッセージのやり取りで行われる。このイベントハンドラを定義するのがCharacterであると言える。characterはactorをメッセージ以外では明示的に提供することはなく、actorの変更は原則としてメッセージのレスポンスでのみ行われる。

## メッセージについて ##
メッセージについては message-system.md を参照

## この方式のメリット・デメリット ##
デメリットとしては、全てをメッセージでのやり取りとした場合、すべてのCharacterで全てのメッセージに対して挙動を定義しなければならない、という点が重いデメリットとなる。

これはメッセージ自体の種類を絞ることと、対応しないメッセージに対しては無反応とするようにすることで、仮に意図しないメッセージが送られてきた場合でも、何も行わないという選択肢ができる。

メリットとしては、この方式の場合は1:nのcharacter同士のやり取りでも特に問題なく行うことが出来る、という点が挙げられる。メッセージがどのように管理されてどのように処理されるかは、より高位のロジックが制御する事柄であるため、characterレベルではそれらを気にする必要はない。

より現状におけるメリットとしてあげられる点は、全てがメッセージでのやり取りとなる場合、テスタビリティが高まるという点が挙げられる。多少実装が煩雑になったとしても、テスタビリティが高まるという点は明確なメリットとなる。
